<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.skyeye.school.dao.KnowledgePointsMationDao">

	<select id="queryKnowledgePointsMationList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.id,
			a.title,
			a.`type`,
			CASE a.`type` WHEN 1 THEN '公开' WHEN 2 THEN '私有' ELSE '未知参数' END typeName,
			b.school_name schoolName,
			c.grade_name gradeName,
			d.subject_name subjectName,
			CONVERT(a.create_time, char) createTime
		FROM
			school_knowledge_points a
			LEFT JOIN school_mation b ON a.school_id = b.id
			LEFT JOIN school_grade_mation c ON a.grade_id = c.id
			LEFT JOIN school_subject_mation d ON a.subject_id = d.id
		WHERE a.whether_delete = '1'
		AND a.create_id = #{createId}
		<if test="title != '' and title != null">
			AND a.title LIKE '%${title}%'
		</if>
		<if test="gradeId != '' and gradeId != null">
			AND a.grade_id = #{gradeId}
		</if>
		<if test="subjectId != '' and subjectId != null">
			AND a.subject_id = #{subjectId}
		</if>
		<if test="typeState != '' and typeState != null">
			AND a.`type` = #{typeState}
		</if>
		<choose>
			<!-- 查询的不是所有的数据 -->
    		<when test="schoolPowerId != 'all'.toString()">
    			AND a.school_id = #{schoolPowerId}
    		</when>
    		<!-- 查询的是所有的数据 -->
    		<when test="schoolPowerId == 'all'.toString()">
    			<if test="schoolId != '' and schoolId != null">
					AND a.school_id = #{schoolId}
				</if>
    		</when>
		</choose>
		ORDER BY a.create_time DESC
	</select>
	
	<select id="queryKnowledgePointsMationByName" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.id
		FROM
			school_knowledge_points a
		WHERE a.title = #{title}
		AND a.school_id = #{schoolId}
		AND a.grade_id = #{gradeId}
		AND a.whether_delete = '1'
	</select>
	
	<insert id="insertKnowledgePointsMation" parameterType="java.util.Map">
	    INSERT into school_knowledge_points 
	    (id, title, content, grade_id, school_id, subject_id, `type`, whether_delete, create_id, create_time)
	    VALUES(#{id}, #{title}, #{content}, #{gradeId}, #{schoolId}, #{subjectId}, #{typeState}, '1', #{createId}, #{createTime})
	</insert>
	
	<update id="deleteKnowledgePointsMationById" parameterType="java.util.Map">
		UPDATE school_knowledge_points
		<set>
			whether_delete = '0',
		</set>
		WHERE id = #{id}
	</update>
	
	<select id="queryKnowledgePointsMationToEditById" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.id,
			a.title,
			a.content,
			a.`type`,
			a.school_id schoolId,
			a.grade_id gradeId,
			a.subject_id subjectId
		FROM
			school_knowledge_points a
		WHERE a.id = #{id}
	</select>
	
	<select id="queryKnowledgePointsMationByNameAndId" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.id
		FROM
			school_knowledge_points a
		WHERE a.title = #{title}
		AND a.school_id = #{schoolId}
		AND a.grade_id = #{gradeId}
		AND a.whether_delete = '1'
		AND a.id != #{id}
	</select>
	
	<update id="editKnowledgePointsMationById" parameterType="java.util.Map">
		UPDATE school_knowledge_points
		<set>
			title = #{title},
			content = #{content},
			`type` = #{typeState},
			school_id = #{schoolId},
			grade_id = #{gradeId},
			subject_id = #{subjectId},
		</set>
		WHERE id = #{id}
	</update>
	
	<select id="queryKnowledgePointsMationById" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.id,
			a.title,
			a.content,
			CASE a.`type` WHEN 1 THEN '公开' WHEN 2 THEN '私有' ELSE '未知参数' END typeName,
			b.school_name schoolName,
			c.grade_name gradeName,
			d.subject_name subjectName
		FROM
			school_knowledge_points a
			LEFT JOIN school_mation b ON a.school_id = b.id
			LEFT JOIN school_grade_mation c ON a.grade_id = c.id
			LEFT JOIN school_subject_mation d ON a.subject_id = d.id
		WHERE a.id = #{id}
	</select>
	
	<select id="queryKnowledgePointsMationListToTable" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.id,
			a.title,
			a.`type`,
			CASE a.`type` WHEN 1 THEN '公开' WHEN 2 THEN '私有' ELSE '未知参数' END typeName,
			b.school_name schoolName,
			c.grade_name gradeName,
			d.subject_name subjectName,
			CONVERT(a.create_time, char) createTime
		FROM
			school_knowledge_points a
			LEFT JOIN school_mation b ON a.school_id = b.id
			LEFT JOIN school_grade_mation c ON a.grade_id = c.id
			LEFT JOIN school_subject_mation d ON a.subject_id = d.id
		WHERE a.whether_delete = '1'
		AND (a.create_id = #{createId} OR a.`type` = '1')
		<if test="title != '' and title != null">
			AND a.title LIKE '%${title}%'
		</if>
		<if test="gradeId != '' and gradeId != null">
			AND a.grade_id = #{gradeId}
		</if>
		<if test="subjectId != '' and subjectId != null">
			AND a.subject_id = #{subjectId}
		</if>
		<if test="typeState != '' and typeState != null">
			AND a.`type` = #{typeState}
		</if>
		<choose>
			<!-- 查询的不是所有的数据 -->
    		<when test="schoolPowerId != 'all'.toString()">
    			AND a.school_id = #{schoolPowerId}
    		</when>
    		<!-- 查询的是所有的数据 -->
    		<when test="schoolPowerId == 'all'.toString()">
    			<if test="schoolId != '' and schoolId != null">
					AND a.school_id = #{schoolId}
				</if>
    		</when>
		</choose>
		ORDER BY a.create_time DESC
	</select>
	
	<select id="queryKnowledgePointsMationListByIds" resultType="java.util.Map">
		SELECT
			a.id,
			a.title
		FROM
			school_knowledge_points a
		WHERE a.whether_delete = '1'
			<if test="idsList != null and idsList.size() &gt; 0">
		        <foreach collection="idsList" item="id" separator="," open=" AND a.id in(" close=")">
		            #{id}
		        </foreach>
		    </if>
		ORDER BY a.create_time DESC
	</select>
	
	<select id="queryKnowledgePointsMationBankList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.id,
			a.title,
			a.`type`,
			CASE a.`type` WHEN 1 THEN '公开' WHEN 2 THEN '私有' ELSE '未知参数' END typeName,
			b.school_name schoolName,
			c.grade_name gradeName,
			d.subject_name subjectName,
			CONVERT(a.create_time, char) createTime
		FROM
			school_knowledge_points a
			LEFT JOIN school_mation b ON a.school_id = b.id
			LEFT JOIN school_grade_mation c ON a.grade_id = c.id
			LEFT JOIN school_subject_mation d ON a.subject_id = d.id
		WHERE a.whether_delete = '1'
		AND (a.create_id = #{createId} OR a.`type` = '1')
		<if test="gradeId != '' and gradeId != null">
			AND a.grade_id = #{gradeId}
		</if>
		<if test="subjectId != '' and subjectId != null">
			AND a.subject_id = #{subjectId}
		</if>
		<choose>
			<!-- 查询的不是所有的数据 -->
    		<when test="schoolPowerId != 'all'.toString()">
    			AND a.school_id = #{schoolPowerId}
    		</when>
    		<!-- 查询的是所有的数据 -->
    		<when test="schoolPowerId == 'all'.toString()">
    			<if test="schoolId != '' and schoolId != null">
					AND a.school_id = #{schoolId}
				</if>
    		</when>
		</choose>
		ORDER BY a.create_time DESC
	</select>
	
</mapper>