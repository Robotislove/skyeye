<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.skyeye.dao.SalesReturnsDao">

    <select id="querySalesReturnsToList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
			a.id,
			a.default_number defaultNumber,
			CONVERT (a.oper_time, char) operTime,
			a.oper_person_name operPersonName,
			d.`name` supplierName,
			FORMAT(a.total_price, 2) totalPrice,
			a.status state,
			a.submit_type submitType,
			IFNULL(a.process_instance_id, '') processInstanceId,
			FORMAT(a.discount_last_money, 2) discountLastMoney,
			FORMAT(IFNULL(a.discount_last_money, 0) + IFNULL(a.discount_money, 0), 2) taxMoney,
			a.link_number linkNumber,
			FORMAT(a.change_amount, 2) changeAmount
		FROM
			erp_depothead a
			LEFT JOIN crm_customer d ON a.organ_id = d.id
		WHERE
			a.sub_type = '2'
		AND a.delete_flag = '0'
        <if test="defaultNumber != '' and defaultNumber != null">
            AND a.default_number LIKE '%${defaultNumber}%'
        </if>
        <if test="startTime != '' and startTime != null and endTime != '' and endTime != null">
			AND a.oper_time >= #{startTime} AND #{endTime} >= a.oper_time
		</if>
        GROUP BY a.id
        ORDER BY a.create_time DESC
    </select>
    
    <select id="queryMationToExcel" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
			a.id,
			a.default_number defaultNumber,
			CONVERT (a.oper_time, char) operTime,
			a.oper_person_name operPersonName,
			d.`name` supplierName,
			FORMAT(a.total_price, 2) totalPrice,
			a.status,
			GROUP_CONCAT(DISTINCT CONCAT(c.material_name, c.material_model) SEPARATOR ',') materialNames,
			FORMAT(a.discount_last_money, 2) discountLastMoney,
			FORMAT(IFNULL(a.discount_last_money, 0) + IFNULL(a.discount_money, 0), 2) taxMoney,
			a.link_number linkNumber,
			FORMAT(a.change_amount, 2) changeAmount
		FROM
			erp_depothead a
			LEFT JOIN crm_customer d ON a.organ_id = d.id
			LEFT JOIN erp_depotitem c ON c.header_id = a.id
		WHERE
			a.sub_type = '2'
		AND a.delete_flag = '0'
        <if test="material != '' and material != null">
            AND c.material_name LIKE '%${material}%'
        </if>
        <if test="defaultNumber != '' and defaultNumber != null">
            AND a.default_number LIKE '%${defaultNumber}%'
        </if>
        <if test="startTime != '' and startTime != null and endTime != '' and endTime != null">
			AND a.oper_time >= #{startTime} AND #{endTime} >= a.oper_time
		</if>
        GROUP BY a.id
        ORDER BY a.create_time DESC
    </select>
    
</mapper>