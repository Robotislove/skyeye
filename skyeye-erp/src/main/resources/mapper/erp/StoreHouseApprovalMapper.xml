<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.skyeye.dao.StoreHouseApprovalDao">

    <select id="queryOrderMationByOrderId" resultType="java.util.Map">
    	SELECT
			a.id,
			a.sub_type subType,
			a.`type`,
			a.`status`,
			a.link_number linkNumber
		FROM
			erp_depothead a
		WHERE a.id = #{orderId}
    </select>
    
    <update id="editWarehouseOrderStateToExamineById" parameterType="java.util.Map">
		UPDATE erp_depothead
		<set>
            `status` = #{status},
			<if test="realComplateTime != '' and realComplateTime != null">
				real_complate_time = #{realComplateTime},
			</if>
		</set>
		WHERE id = #{id}
		AND sub_type = #{subType}
	</update>
	
    <select id="queryNoStockListMationByOrderId" resultType="java.util.Map">
    	SELECT
    		*
    	FROM
			(SELECT
				e.id,
				IFNULL((SELECT SUM(it.initial_tock) FROM erp_material_norms_tock it WHERE e.norms_id = it.norms_id AND it.depot_id = e.depot_id), 0) + 
					IFNULL((SELECT SUM(sn.stock_num) FROM erp_material_depot_stock sn WHERE e.norms_id = sn.norms_id AND sn.depot_id = e.depot_id), 0) nowTock,
				a.`name` materialName
			FROM
				erp_depotitem e,
				erp_material a
			WHERE e.header_id = #{orderId}
			AND e.material_id = a.id) k
		WHERE k.nowTock &lt; 0
	</select>
	
	<select id="queryNotApprovedOtherOrderList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
			a.id,
			a.default_number defaultNumber,
			a.sub_type subType,
			CONVERT (a.oper_time, char) operTime,
			a.oper_person_name operPersonName,
			b.supplier supplierName,
			FORMAT(a.total_price, 2) totalPrice,
			a.`status`,
			GROUP_CONCAT(DISTINCT CONCAT(c.material_name, c.material_model) SEPARATOR ',') materialNames,
			FORMAT(a.discount_last_money, 2) discountLastMoney,
			FORMAT(IFNULL(a.discount_last_money, 0) + IFNULL(a.discount_money, 0), 2) taxMoney,
			a.link_number linkNumber,
			FORMAT(a.change_amount, 2) changeAmount,
			CASE a.sub_type WHEN 12 THEN '拆分单' WHEN 13 THEN '组装单' WHEN 14 THEN '调拨单'
							ELSE '' END subTypeName
		FROM
			erp_depothead a
			LEFT JOIN erp_supplier b ON a.organ_id = b.id
			LEFT JOIN erp_depotitem c ON c.header_id = a.id
		WHERE
			a.`type` = '3' #其他单据
		AND a.delete_flag = '0'
		AND a.status = '1'
		AND c.depot_id = #{depotId}
		AND a.sub_type IN (12, 13, 14)
        <if test="defaultNumber != '' and defaultNumber != null">
            AND a.default_number LIKE '%${defaultNumber}%'
        </if>
        <if test="startTime != '' and startTime != null and endTime != '' and endTime != null">
			AND a.oper_time >= #{startTime} AND #{endTime} >= a.oper_time
		</if>
        GROUP BY a.id
        ORDER BY a.create_time DESC
    </select>
    
    <select id="queryNoStockSplitListMationByOrderId" resultType="java.util.Map">
    	SELECT
    		*
    	FROM
			(SELECT
				e.id,
				IFNULL((SELECT SUM(it.initial_tock) FROM erp_material_norms_tock it WHERE e.norms_id = it.norms_id AND it.depot_id = e.depot_id), 0) + 
					IFNULL((SELECT SUM(sn.stock_num) FROM erp_material_depot_stock sn WHERE e.norms_id = sn.norms_id AND sn.depot_id = e.depot_id), 0) nowTock,
				a.`name` materialName
			FROM
				erp_depotitem e,
				erp_material a
			WHERE e.header_id = #{orderId}
			AND e.material_id = a.id
			AND e.m_type = '1') k
		WHERE k.nowTock &lt; 0
	</select>
	
	<select id="queryNoStockAssemblyListMationByOrderId" resultType="java.util.Map">
    	SELECT
    		*
    	FROM
			(SELECT
				e.id,
				IFNULL((SELECT SUM(it.initial_tock) FROM erp_material_norms_tock it WHERE e.norms_id = it.norms_id AND it.depot_id = e.depot_id), 0) + 
					IFNULL((SELECT SUM(sn.stock_num) FROM erp_material_depot_stock sn WHERE e.norms_id = sn.norms_id AND sn.depot_id = e.depot_id), 0) nowTock,
				a.`name` materialName
			FROM
				erp_depotitem e,
				erp_material a
			WHERE e.header_id = #{orderId}
			AND e.material_id = a.id
			AND e.m_type = '2') k
		WHERE k.nowTock &lt; 0
	</select>
	
    <select id="queryPassApprovedOtherOrderList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
			a.id,
			a.default_number defaultNumber,
			a.sub_type subType,
			CONVERT (a.oper_time, char) operTime,
			a.oper_person_name operPersonName,
			b.supplier supplierName,
			FORMAT(a.total_price, 2) totalPrice,
			a.`status`,
			GROUP_CONCAT(DISTINCT CONCAT(c.material_name, c.material_model) SEPARATOR ',') materialNames,
			FORMAT(a.discount_last_money, 2) discountLastMoney,
			FORMAT(IFNULL(a.discount_last_money, 0) + IFNULL(a.discount_money, 0), 2) taxMoney,
			a.link_number linkNumber,
			FORMAT(a.change_amount, 2) changeAmount,
			CASE a.sub_type WHEN 12 THEN '拆分单' WHEN 13 THEN '组装单' WHEN 14 THEN '调拨单'
							ELSE '' END subTypeName
		FROM
			erp_depothead a
			LEFT JOIN erp_supplier b ON a.organ_id = b.id
			LEFT JOIN erp_depotitem c ON c.header_id = a.id
		WHERE
			a.`type` = '3' #其他单据
		AND a.delete_flag = '0'
		AND a.status = '2'
		AND c.depot_id = #{depotId}
		AND a.sub_type IN (12, 13, 14)
        <if test="defaultNumber != '' and defaultNumber != null">
            AND a.default_number LIKE '%${defaultNumber}%'
        </if>
        <if test="startTime != '' and startTime != null and endTime != '' and endTime != null">
			AND a.oper_time >= #{startTime} AND #{endTime} >= a.oper_time
		</if>
        GROUP BY a.id
        ORDER BY a.create_time DESC
    </select>

</mapper>